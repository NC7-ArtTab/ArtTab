<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="arttab.server.dao.BidDao">

    <resultMap id="artMap" type="arttab.server.vo.Art">
        <id property="artNo" column="art_no"/>
        <result property="artTitle" column="art_title"/>
        <result property="artCategory" column="art_category"/>
        <result property="artWriter" column="art_writer"/>
        <result property="artContent" column="art_content"/>
        <result property="artDetail" column="art_detail"/>
        <result property="startPrice" column="start_price"/>
        <result property="buyNowPrice" column="buy_now_price"/>
        <result property="bidPricePer" column="bid_price_per"/>
        <result property="startDatetime" column="start_datetime"/>
        <result property="endDatetime" column="end_datetime"/>
        <result property="artRegDatetime" column="art_reg_datetime"/>
        <result property="artStatus" column="art_status"/>

        <collection property="artAttaches" ofType="arttab.server.vo.Attach">
            <result property="fileNo" column="attach_file_no"/>
            <result property="filePath" column="attach_file_path"/>
            <result property="originFileName" column="attach_origin_file_name"/>
            <result property="saveFileName" column="attach_save_file_name"/>
        </collection>

        <collection property="artBids" ofType="arttab.server.vo.Bid">
            <id property="bidNo" column="bid_no"/>
            <result property="bidPrice" column="bid_price"/>
            <result property="bidDatetime" column="bid_datetime"/>
            <result property="memNo" column="mem_no"/>
        </collection>
    </resultMap>

    <resultMap id="memMap" type="arttab.server.vo.Member">
        <id property="memNo" column="mem_no"/>
        <result property="memEmail" column="mem_email"/>
        <result property="memPwd" column="mem_pwd"/>
        <result property="memName" column="mem_name"/>
        <result property="memPhone" column="mem_phone"/>
        <result property="memZipcode" column="mem_zipcode"/>
        <result property="memAddr" column="mem_addr"/>
        <result property="memDetailAddr" column="mem_detail_addr"/>
        <result property="memBank" column="mem_bank"/>
        <result property="memAcc" column="mem_acc"/>
        <result property="memAuth" column="mem_auth"/>
        <result property="memDatetime" column="mem_datetime"/>
        <result property="memStatus" column="mem_status"/>

        <collection property="memBids" ofType="arttab.server.vo.Bid">
            <id property="bidNo" column="bid_no"/>
            <result property="bidPrice" column="bid_price"/>
            <result property="bidDatetime" column="bid_datetime"/>
            <result property="artNo" column="art_no"/>
        </collection>
    </resultMap>

    <resultMap id="bidMap" type="arttab.server.vo.Bid">
        <id property="bidNo" column="bid_no"/>
        <result property="artNo" column="art_no"/>
        <result property="bidPrice" column="bid_price"/>
        <result property="bidDatetime" column="bid_datetime"/>
        <result property="memNo" column="mem_no"/>
    </resultMap>

    <resultMap id="artDetailMap" type="arttab.server.dto.ArtDetailDto">
        <id property="artNo" column="art_no"/>
        <result property="artTitle" column="art_title"/>
        <result property="artCategory" column="art_category"/>
        <result property="artWriter" column="art_writer"/>
        <result property="artContent" column="art_content"/>
        <result property="artDetail" column="art_detail"/>
        <result property="startPrice" column="start_price"/>
        <result property="buyNowPrice" column="buy_now_price"/>
        <result property="bidPricePer" column="bid_price_per"/>
        <result property="startDatetime" column="start_datetime"/>
        <result property="endDatetime" column="end_datetime"/>
        <result property="artRegDatetime" column="art_reg_datetime"/>
        <result property="artStatus" column="art_status"/>
        <result property="maxBidPrice" column="max_bid_price"/>
        <result property="nextBidPrice" column="next_bid_price"/>
        <result property="memNo" column="mem_no"/>
    </resultMap>

    <!-- 경매 상품 상세 정보 조회 -->
    <select id="artDetail" resultMap="artDetailMap">
        SELECT a.*,
        (SELECT MAX(b.bid_price) FROM bid b WHERE b.art_no = #{artNo}) AS max_bid_price,
        COALESCE((SELECT MAX(b.bid_price) FROM bid b WHERE b.art_no = #{artNo}), a.start_price) +
        a.bid_price_per AS next_bid_price,
        m.mem_no
        FROM art a
        LEFT JOIN bid b ON a.art_no = b.art_no
        LEFT JOIN member m ON b.mem_no = m.mem_no
        WHERE a.art_no = #{artNo}
        GROUP BY a.art_no, m.mem_no;
    </select>

    <!-- 현재까지의 입찰 순위 조회 -->
    <select id="bidRank" resultMap="bidMap">
        SELECT b.bid_no, b.mem_no, b.bid_price, b.bid_datetime, m.mem_name
        FROM bid b
        INNER JOIN member m ON b.mem_no = m.mem_no
        WHERE b.art_no = #{artNo}
        ORDER BY b.bid_price DESC, b.bid_datetime ASC;
    </select>

    <!-- 입찰하기 -->
    <insert id="insertBid" parameterMap="bidMap">
        INSERT INTO bid (art_no, mem_no, bid_price, bid_datetime)
        VALUES (#{artNo}, #{memNo}, #{bidPrice}, NOW());
    </insert>

</mapper>